<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Ä¢ CTF Tournament</title>
  <link rel="stylesheet" href="/static/assets/styles.css">
</head>

<body class="app landing">
<header class="appbar landing-header">
  <div class="landing-shell appbar-inner">
    <div class="brand">
      <div class="brand-mark">CTF</div>
      <div class="brand-text">
        <div class="brand-title">CTF Tournament</div>
        <div class="brand-sub">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</div>
      </div>
    </div>

    <div class="appbar-right landing-actions">
      <div class="pill" id="who">user ‚Ä¢ points=0</div>
      <button class="btn secondary" id="ratingBtn">–†–µ–π—Ç–∏–Ω–≥</button>
      <button class="btn secondary" id="logoutBtn">–í—ã—Ö–æ–¥</button>
    </div>
  </div>
</header>

<main class="landing-shell app-layout">
  <!-- SIDEBAR -->
  <aside class="side glass">
    <div class="side-top">
      <div class="side-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
      <div class="small muted" id="roleHint">‚Äî</div>
    </div>

    <div class="side-nav">
      <button class="navbtn active" data-view="matches">
        <span class="navico">üéØ</span><span>–ú–∞—Ç—á–∏</span>
      </button>
      <button class="navbtn" data-view="teams">
        <span class="navico">üë•</span><span>–ö–æ–º–∞–Ω–¥—ã</span>
      </button>
      <button class="navbtn" data-view="history">
        <span class="navico">üïò</span><span>–ò—Å—Ç–æ—Ä–∏—è</span>
      </button>
      <button class="navbtn" data-view="rating">
        <span class="navico">üèÜ</span><span>–†–µ–π—Ç–∏–Ω–≥</span>
      </button>

      <div class="side-sep"></div>

      <button class="navbtn hidden" id="navAdmin" data-view="admin">
        <span class="navico">üõ†</span><span>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</span>
      </button>
    </div>

    <div class="side-foot">
      <div class="meta grid">
        <div class="meta-item">
          <div class="meta-label">–†–æ–ª—å</div>
          <div class="meta-value" id="roleLine">‚Äî</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">–û—á–∫–∏</div>
          <div class="meta-value" id="pointsLine">‚Äî</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- CONTENT -->
  <section class="content">
    <div id="toast" class="toast hidden"></div>

    <!-- MATCHES -->
    <section id="view-matches" class="panel glass">
      <div class="panel-head">
        <div>
          <h2>–ú–∞—Ç—á–∏</h2>
          <div class="muted small">–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ç—á–∏ –∏ –ø–æ–¥–∞—á–∞ –∑–∞—è–≤–æ–∫</div>
        </div>
        <div class="seg" id="userMatchTabs">
          <button class="seg-btn active" data-status="open">–û—Ç–∫—Ä—ã—Ç—ã–µ</button>
          <button class="seg-btn" data-status="finished">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
        </div>
      </div>

      <div id="matchesOut" class="panel-body">
        <div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </section>

    <!-- TEAMS -->
    <section id="view-teams" class="panel glass hidden">
      <div class="panel-head">
        <div>
          <h2>–ö–æ–º–∞–Ω–¥—ã</h2>
          <div class="muted small">–°–æ–∑–¥–∞–Ω–∏–µ, –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ, –≤—ã—Ö–æ–¥</div>
        </div>
        <div class="row">
          <button class="btn secondary" id="listTeams">–û—Ç–∫—Ä—ã—Ç—ã–µ</button>
          <button class="btn secondary" id="listMyTeams">–ú–æ–∏</button>
        </div>
      </div>

      <div class="panel-body">
        <div class="card glass inner">
          <div class="grid2">
            <label class="field">
              <span class="field-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã</span>
              <input id="teamName" maxlength="32" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: byteBusters">
            </label>

            <label class="field">
              <span class="field-label">–¢–∏–ø</span>
              <select id="teamOpen">
                <option value="true">–û—Ç–∫—Ä—ã—Ç–∞—è</option>
                <option value="false">–ó–∞–∫—Ä—ã—Ç–∞—è</option>
              </select>
            </label>
          </div>

          <div class="row" style="margin-top:10px; align-items:center;">
            <button class="btn" id="createTeam">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
            <div class="small muted" id="teamRuleHint">–û—Ç–∫—Ä—ã—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã –º–æ–∂–Ω–æ —Å–≤–æ–±–æ–¥–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—Ç—å.</div>
          </div>
        </div>

        <div id="teamsOut" class="stack"></div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="view-history" class="panel glass hidden">
      <div class="panel-head">
        <div>
          <h2>–ò—Å—Ç–æ—Ä–∏—è —É—á–∞—Å—Ç–∏—è</h2>
          <div class="muted small">–ú–∞—Ç—á–∏, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Ç—ã —É—á–∞—Å—Ç–≤–æ–≤–∞–ª (–ø–æ—Å–ª–µ approve)</div>
        </div>
        <button class="btn secondary" id="reloadHistory">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div id="historyOut" class="panel-body">
        <div class="empty muted">–ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é.</div>
      </div>
    </section>

    <!-- RATING -->
    <section id="view-rating" class="panel glass hidden">
      <div class="panel-head">
        <div>
          <h2>–†–µ–π—Ç–∏–Ω–≥</h2>
          <div class="muted small">–¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –æ—á–∫–∞–º</div>
        </div>
        <button class="btn secondary" id="reloadRating">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div id="ratingOut" class="panel-body">
        <div class="empty muted">–ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥.</div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="view-admin" class="panel glass hidden adminx">
      <div class="adminx-top">
        <div class="adminx-title">
          <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
          <div class="muted small">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç—á–∞–º–∏ ‚Ä¢ –∑–∞—è–≤–∫–∞–º–∏ ‚Ä¢ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ ‚Ä¢ –ª–æ–≥–∞–º–∏</div>
        </div>

        <div class="adminx-tabs seg" id="adminTabs">
          <button class="seg-btn active" data-admin="matches">–ú–∞—Ç—á–∏</button>
          <button class="seg-btn" data-admin="apps">–ó–∞—è–≤–∫–∏</button>
          <button class="seg-btn" data-admin="users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
          <button class="seg-btn" data-admin="teams">–ö–æ–º–∞–Ω–¥—ã</button>
          <button class="seg-btn" data-admin="logs">–õ–æ–≥–∏</button>
        </div>
      </div>

      <div class="adminx-body">
        <!-- MATCHES -->
        <section id="admin-matches" class="adminx-card">
          <div class="adminx-cardhead">
            <div>
              <div class="adminx-cardtitle">–ú–∞—Ç—á–∏</div>
              <div class="muted small">–°–æ–∑–¥–∞–Ω–∏–µ ‚Ä¢ —Å–ø–∏—Å–æ–∫ ‚Ä¢ –ø–æ–±–µ–¥–∏—Ç–µ–ª—å ‚Ä¢ –æ—Ç—á—ë—Ç</div>
            </div>
          </div>

          <div class="adminx-form">
            <div class="adminx-formgrid">
              <label class="field">
                <span class="field-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞</span>
                <input id="mTitle" maxlength="60" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: Crypto Sprint">
              </label>

              <label class="field">
                <span class="field-label">–†–µ–∂–∏–º</span>
                <select id="mMode">
                  <option value="solo">Solo</option>
                  <option value="team">Team</option>
                </select>
              </label>

              <label class="field">
                <span class="field-label">–§–∏–ª—å—Ç—Ä</span>
                <select id="mFilter">
                  <option value="all">–í—Å–µ</option>
                  <option value="open">–û—Ç–∫—Ä—ã—Ç—ã–µ</option>
                  <option value="finished">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</option>
                </select>
              </label>

              <div class="adminx-actions">
                <button class="btn" id="mCreate">–°–æ–∑–¥–∞—Ç—å</button>
                <button class="btn secondary" id="mListAll">–ü–æ–∫–∞–∑–∞—Ç—å</button>
              </div>
            </div>
          </div>

          <div class="adminx-block">
            <div class="muted small" style="margin-bottom:10px;">–°–ø–∏—Å–æ–∫ –º–∞—Ç—á–µ–π</div>
            <div id="matchesAdminOut" class="adminx-tablewrap"></div>
          </div>
        </section>

        <!-- APPS -->
        <section id="admin-apps" class="adminx-card hidden">
          <div class="adminx-cardhead">
            <div>
              <div class="adminx-cardtitle">–ó–∞—è–≤–∫–∏</div>
              <div class="muted small">Approve / Reject</div>
            </div>
            <button class="btn secondary" id="reloadApps">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
          <div id="appsOut" class="adminx-tablewrap"></div>
        </section>

        <!-- USERS -->
        <section id="admin-users" class="adminx-card hidden">
          <div class="adminx-cardhead">
            <div>
              <div class="adminx-cardtitle">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
              <div class="muted small">–û—á–∫–∏ –∏ —É–¥–∞–ª–µ–Ω–∏–µ</div>
            </div>
            <button class="btn secondary" id="reloadUsers">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
          <div id="usersOut" class="adminx-tablewrap"></div>
        </section>

        <!-- TEAMS (ADMIN) -->
        <section id="admin-teams" class="adminx-card hidden">
          <div class="adminx-cardhead">
            <div>
              <div class="adminx-cardtitle">–ö–æ–º–∞–Ω–¥—ã</div>
              <div class="muted small">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –∑–∞–∫—Ä—ã—Ç—É—é –∫–æ–º–∞–Ω–¥—É (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)</div>
            </div>
            <button class="btn secondary" id="reloadTeamsAdmin">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>

          <div class="adminx-form">
            <div class="adminx-formgrid" style="grid-template-columns: 1fr 1fr auto;">
              <label class="field">
                <span class="field-label">–ó–∞–∫—Ä—ã—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞</span>
                <select id="adminTeamSel">
                  <option value="">‚Äî –≤—ã–±–µ—Ä–∏ –∫–æ–º–∞–Ω–¥—É ‚Äî</option>
                </select>
              </label>

              <label class="field">
                <span class="field-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                <select id="adminUserSel">
                  <option value="">‚Äî –≤—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî</option>
                </select>
              </label>

              <div class="adminx-actions" style="justify-content:flex-start;">
                <button class="btn" id="adminAddToTeamBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
          </div>

          <div class="adminx-block">
            <div class="muted small" style="margin-bottom:10px;">–°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥</div>
            <div id="teamsAdminOut" class="adminx-tablewrap"></div>
          </div>
        </section>

        <!-- LOGS -->
        <section id="admin-logs" class="adminx-card hidden">
          <div class="adminx-cardhead">
            <div>
              <div class="adminx-cardtitle">–õ–æ–≥–∏</div>
              <div class="muted small">–°–æ–±—ã—Ç–∏—è (–±–µ–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)</div>
            </div>
            <button class="btn secondary" id="reloadLogs">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
          <div id="logsOut" class="adminx-tablewrap"></div>
        </section>

        <!-- REPORT -->
        <section id="reportCard" class="adminx-card hidden">
          <div class="adminx-cardhead">
            <div>
              <div class="adminx-cardtitle">–û—Ç—á—ë—Ç –ø–æ –º–∞—Ç—á—É</div>
              <div class="muted small">–°–≤–æ–¥–∫–∞</div>
            </div>
            <div class="row" style="justify-content:flex-end;">
              <button class="btn secondary" id="copyReport">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="btn secondary" id="closeReport">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
          </div>
          <div style="padding:14px;">
            <pre id="reportText" class="adminx-pre"></pre>
          </div>
        </section>
      </div>
    </section>

    <div id="err" class="small errline"></div>
  </section>
</main>

<div class="noise"></div>

<script type="module">
import { api } from "/static/assets/api.js";

/* ---------- security + helpers ---------- */
const LIMITS = { TEAM_NAME: 32, MATCH_TITLE: 60 };
const MAX_TEAM_MEMBERS = 5;

function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function clampStr(s, max){
  s = String(s ?? "").trim();
  if (s.length > max) s = s.slice(0, max);
  return s;
}

function ruMatchStatus(st){
  st = String(st||"").toLowerCase();
  if (st === "open") return "–û—Ç–∫—Ä—ã—Ç—ã–π";
  if (st === "finished") return "–ó–∞–≤–µ—Ä—à—ë–Ω";
  return st || "‚Äî";
}
function ruAppStatus(st){
  st = String(st||"").toLowerCase();
  if (st === "pending") return "–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞";
  if (st === "approved") return "–û–¥–æ–±—Ä–µ–Ω–∞";
  if (st === "rejected") return "–û—Ç–∫–ª–æ–Ω–µ–Ω–∞";
  return st || "‚Äî";
}
function ruMode(m){
  m = String(m||"").toLowerCase();
  if (m === "solo") return "Solo";
  if (m === "team") return "Team";
  return m || "‚Äî";
}

function ruErrorMessage(msg){
  const m = String(msg || "").toLowerCase();
  if (!m) return "–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
  if (m.includes("unauthorized")) return "–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç.";
  if (m.includes("–º–∞—Ç—á –Ω–µ –Ω–∞–π–¥–µ–Ω") || m.includes("match not found")) return "–ú–∞—Ç—á –Ω–µ –Ω–∞–π–¥–µ–Ω.";
  return String(msg || "–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
}

function showActionRu(action){
  const a = String(action || "");
  const map = {
    "seed_admin": "–°–æ–∑–¥–∞–Ω –∞–¥–º–∏–Ω-–∞–∫–∫–∞—É–Ω—Ç",
    "login": "–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É",
    "logout": "–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã",
    "register": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è",
    "apply_match": "–ü–æ–¥–∞—á–∞ –∑–∞—è–≤–∫–∏",
    "admin_create_match": "–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç—á–∞",
    "admin_update_match": "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ç—á–∞",
    "admin_approve_application": "–ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞",
    "admin_reject_application": "–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞",
    "create_team": "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã",
    "join_team": "–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –∫–æ–º–∞–Ω–¥—É",
    "leave_team": "–í—ã—Ö–æ–¥ –∏–∑ –∫–æ–º–∞–Ω–¥—ã",
    "admin_set_points": "–ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ—á–∫–æ–≤",
    "admin_delete_user": "–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
    "admin_set_winner": "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è",
    "admin_add_user_to_team": "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∑–∞–∫—Ä—ã—Ç—É—é –∫–æ–º–∞–Ω–¥—É",
  };
  return map[a] || a || "–°–æ–±—ã—Ç–∏–µ";
}

/* ---------- base ---------- */
const errEl = document.getElementById("err");
const who = document.getElementById("who");
const toast = document.getElementById("toast");

const roleLine = document.getElementById("roleLine");
const pointsLine = document.getElementById("pointsLine");
const roleHint = document.getElementById("roleHint");
const navAdmin = document.getElementById("navAdmin");

const createTeamBtn = document.getElementById("createTeam");
const teamRuleHint = document.getElementById("teamRuleHint");

const views = ["matches","teams","history","rating","admin"].reduce((acc,k)=>{
  acc[k]=document.getElementById("view-"+k); return acc;
},{});

function err(m){ errEl.textContent = m || ""; }
function showToast(text, ok=true){
  toast.textContent = text;
  toast.classList.remove("hidden");
  toast.classList.toggle("bad", !ok);
  setTimeout(()=> toast.classList.add("hidden"), 2200);
}
function setView(name){
  Object.keys(views).forEach(k=>{
    if (k===name) views[k].classList.remove("hidden");
    else views[k].classList.add("hidden");
  });
  document.querySelectorAll(".navbtn").forEach(b=>{
    b.classList.toggle("active", b.dataset.view===name);
  });
}

document.getElementById("logoutBtn").onclick = async () => {
  try { await api("/auth/logout","POST"); } catch {}
  location.href="/";
};
document.getElementById("ratingBtn").onclick = () => {
  setView("rating");
  loadRating();
};
document.querySelectorAll(".navbtn").forEach(b=>{
  b.onclick = () => {
    const v = b.dataset.view;
    setView(v);
    if (v==="matches") loadMatches(activeStatus());
    if (v==="history") loadHistory();
    if (v==="rating") loadRating();
    if (v==="admin") loadAdminMatches();
    if (v==="teams") refreshTeamRuleUI();
  };
});

/* ---------- user match tabs ---------- */
function activeStatus(){
  const a = document.querySelector("#userMatchTabs .seg-btn.active");
  return a ? a.dataset.status : "open";
}
document.querySelectorAll("#userMatchTabs .seg-btn").forEach(t=>{
  t.onclick = () => {
    document.querySelectorAll("#userMatchTabs .seg-btn").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    loadMatches(t.dataset.status);
  };
});

/* ---------- load me ---------- */
async function loadMe(){
  err("");
  try{
    const me = await api("/me");
    who.textContent = `${me.username} (${me.role}) ‚Ä¢ points=${me.points}`;
    roleLine.textContent = me.role;
    pointsLine.textContent = String(me.points);
    roleHint.textContent = me.role === "admin" ? "–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏" : "–ü–æ–¥–∞—á–∞ –∑–∞—è–≤–æ–∫ –∏ –∫–æ–º–∞–Ω–¥—ã";
    if (me.role === "admin") navAdmin.classList.remove("hidden");
    else navAdmin.classList.add("hidden");
  }catch{
    location.href="/login";
  }
}

/* ---------- team rule helpers ---------- */
async function getMyTeams(){
  const resTeams = await api("/my/teams");
  return Array.isArray(resTeams) ? resTeams : (Array.isArray(resTeams?.teams) ? resTeams.teams : []);
}
async function refreshTeamRuleUI(){
  try{
    const myTeams = await getMyTeams();
    const hasTeam = (myTeams || []).length > 0;

    if (hasTeam){
      createTeamBtn.disabled = true;
      createTeamBtn.classList.add("secondary");
      teamRuleHint.textContent = "–í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–æ–º–∞–Ω–¥–µ. –ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å/–≤—Å—Ç—É–ø–∏—Ç—å –≤ –¥—Ä—É–≥—É—é ‚Äî —Å–Ω–∞—á–∞–ª–∞ –≤—ã–π–¥–∏—Ç–µ.";
    } else {
      createTeamBtn.disabled = false;
      createTeamBtn.classList.remove("secondary");
      teamRuleHint.textContent = "–û—Ç–∫—Ä—ã—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã –º–æ–∂–Ω–æ —Å–≤–æ–±–æ–¥–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—Ç—å.";
    }
  }catch{}
}

/* ---------- user: matches ---------- */
async function loadMatches(status){
  const out = document.getElementById("matchesOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç—á–µ–π...</div>`;

  let matches = [];
  let myApps = {};
  let myTeams = [];

  try{
    const res = await api(`/matches?status=${encodeURIComponent(status)}`);
    matches = Array.isArray(res) ? res : (Array.isArray(res?.matches) ? res.matches : []);

    const resApps = await api("/my/applications");
    myApps = (resApps && typeof resApps === "object") ? resApps : {};

    myTeams = await getMyTeams();
  }catch(e){
    out.innerHTML = `<div class="empty bad">${esc(ruErrorMessage(e.message))}</div>`;
    return;
  }

  if (!matches.length){
    out.innerHTML = `<div class="empty">–ú–∞—Ç—á–µ–π –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´<b>${esc(status==="open"?"–û—Ç–∫—Ä—ã—Ç—ã–µ":"–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ")}</b>¬ª –Ω–µ—Ç</div>`;
    return;
  }

  const teamOptions = (myTeams||[]).map(t=>`<option value="${t.id}">${esc(t.name)}</option>`).join("");

  out.innerHTML = `<div class="stack">` + matches.map(m=>{
    const appSt = myApps[m.id] || "none";
    const isOpenMatch = (String(m.status).toLowerCase() === "open");
    const applied = appSt !== "none";

    const badge = appSt==="none" ? "–∑–∞—è–≤–∫–∞: ‚Äî" : `–∑–∞—è–≤–∫–∞: ${esc(ruAppStatus(appSt))}`;

    const teamPick = (m.mode==="team" && isOpenMatch && !applied) ? `
      <label class="field inline" style="min-width:240px;">
        <span class="field-label">–ö–æ–º–∞–Ω–¥–∞</span>
        <select data-team="${m.id}">
          <option value="">–í—ã–±–µ—Ä–∏ –∫–æ–º–∞–Ω–¥—É</option>
          ${teamOptions}
        </select>
      </label>` : "";

    const btnText = !isOpenMatch ? "–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω" : (applied ? "–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞" : "–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É");
    const btnDisabled = (!isOpenMatch || applied);

    return `
      <div class="item glass inner">
        <div class="item-head">
          <div class="item-title">${esc(m.title)}</div>
          <div class="badges">
            <span class="badge">${esc(ruMatchStatus(m.status))}</span>
            <span class="badge">${esc(ruMode(m.mode))}</span>
            <span class="badge">${badge}</span>
          </div>
        </div>

        <div class="item-actions">
          ${teamPick}
          <button class="btn ${btnDisabled ? "secondary" : ""}" data-apply="${m.id}" ${btnDisabled ? "disabled" : ""}>${btnText}</button>
          <div class="small muted"></div>
        </div>
      </div>
    `;
  }).join("") + `</div>`;

  out.querySelectorAll("button[data-apply]").forEach(btn=>{
    btn.onclick = async () => {
      const matchId = Number(btn.dataset.apply);
      const card = btn.closest(".item");
      const msg = card.querySelector(".small");
      msg.textContent = "";
      msg.classList.remove("bad");

      const m = matches.find(x=>x.id===matchId);
      if (!m) return;

      if (String(m.status).toLowerCase() !== "open"){
        msg.textContent = "–ù–µ–ª—å–∑—è –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –º–∞—Ç—á.";
        msg.classList.add("bad");
        return;
      }

      let body = {};
      if (m.mode==="team"){
        const sel = card.querySelector(`select[data-team="${matchId}"]`);
        const teamId = sel ? sel.value : "";
        if (!teamId){
          msg.textContent = "–í—ã–±–µ—Ä–∏ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ –º–∞—Ç—á–∞.";
          msg.classList.add("bad");
          return;
        }
        body.team_id = Number(teamId);
      }

      try{
        await api(`/matches/${matchId}/apply`, "POST", body);
        btn.textContent = "–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞";
        btn.disabled = true;
        btn.classList.add("secondary");
        showToast("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚úÖ", true);
      }catch(e){
        msg.textContent = ruErrorMessage(e.message);
        msg.classList.add("bad");
      }
    };
  });
}

/* ---------- user: teams ---------- */
document.getElementById("createTeam").onclick = async () => {
  try{
    const myTeams = await getMyTeams();
    if ((myTeams||[]).length > 0){
      showToast("–°–Ω–∞—á–∞–ª–∞ –≤—ã–π–¥–∏—Ç–µ –∏–∑ —Ç–µ–∫—É—â–µ–π –∫–æ–º–∞–Ω–¥—ã.", false);
      await refreshTeamRuleUI();
      return;
    }
  }catch{}

  let name = document.getElementById("teamName").value;
  name = clampStr(name, LIMITS.TEAM_NAME);

  const is_open = document.getElementById("teamOpen").value === "true";
  if (!name){ showToast("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã.", false); return; }

  try{
    await api("/teams","POST",{name,is_open});
    showToast("–ö–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–Ω–∞ ‚úÖ", true);
    document.getElementById("teamName").value = "";
    await refreshTeamRuleUI();
    await loadMyTeams();
  }catch(e){
    showToast(ruErrorMessage(e.message), false);
  }
};

async function loadOpenTeams(){
  const out = document.getElementById("teamsOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;

  try{
    const [openRes, myRes] = await Promise.all([
      api("/teams/open"),
      api("/my/teams")
    ]);

    const teams = Array.isArray(openRes) ? openRes : (Array.isArray(openRes?.teams) ? openRes.teams : []);
    const myTeams = Array.isArray(myRes) ? myRes : (Array.isArray(myRes?.teams) ? myRes.teams : []);

    const mySet = new Set((myTeams || []).map(t => t.id));
    const alreadyInAnyTeam = mySet.size > 0;

    if (!teams.length){
      out.innerHTML = `<div class="empty">–û—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ–º–∞–Ω–¥ –Ω–µ—Ç</div>`;
      return;
    }

    out.innerHTML = `<div class="stack">` + teams.map(t=>{
      const inThisTeam = mySet.has(t.id);
      const members = Array.isArray(t.members) ? t.members : [];
      const membersCount = members.length;
      const isFull = membersCount >= MAX_TEAM_MEMBERS;

      const membersLine = membersCount
        ? members.map(m=>esc(m.username)).join(", ")
        : "–ø–æ–∫–∞ –ø—É—Å—Ç–æ";

      const canJoin = (!inThisTeam && !alreadyInAnyTeam && !isFull);

      return `
        <div class="item glass inner">
          <div class="item-head">
            <div>
              <div class="item-title">${esc(t.name)}</div>
              <div class="small muted" style="margin-top:6px;">
                –£—á–∞—Å—Ç–Ω–∏–∫–∏: <b>${membersCount}/${MAX_TEAM_MEMBERS}</b>
              </div>
            </div>

            <div class="badges">
              <span class="badge">${t.is_open ? "open" : "closed"}</span>
              ${isFull ? `<span class="badge danger">FULL</span>` : ``}
              ${inThisTeam ? `<span class="badge success">–≤—ã —É—á–∞—Å—Ç–Ω–∏–∫</span>` : ``}
            </div>
          </div>

          <div class="small muted" style="margin-top:10px;">
            –°–æ—Å—Ç–∞–≤: <b>${membersLine}</b>
          </div>

          <div class="item-actions" style="margin-top:12px;">
            ${canJoin ? `<button class="btn secondary" data-join="${t.id}">–í—Å—Ç—É–ø–∏—Ç—å</button>` : ``}
            ${inThisTeam ? `<button class="btn secondary" data-leave="${t.id}">–í—ã–π—Ç–∏</button>` : ``}

            ${(!inThisTeam && alreadyInAnyTeam) ? `
              <div class="small muted">–ü–æ–∫–∞ –≤—ã –≤ –∫–æ–º–∞–Ω–¥–µ ‚Äî –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –¥—Ä—É–≥–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.</div>
            ` : ``}

            ${(!inThisTeam && !alreadyInAnyTeam && isFull) ? `
              <div class="small muted">–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ (–º–∞–∫—Å–∏–º—É–º ${MAX_TEAM_MEMBERS}).</div>
            ` : ``}
          </div>
        </div>
      `;
    }).join("") + `</div>`;

    out.querySelectorAll("button[data-join]").forEach(b=>{
      b.onclick = async ()=>{
        try{
          await api(`/teams/${b.dataset.join}/join`, "POST");
          showToast("–í—Å—Ç—É–ø–∏–ª–∏ ‚úÖ", true);
          await refreshTeamRuleUI();
          await loadOpenTeams();
        }catch(e){
          showToast(ruErrorMessage(e.message), false);
        }
      };
    });

    out.querySelectorAll("button[data-leave]").forEach(b=>{
      b.onclick = async ()=>{
        try{
          await api(`/teams/${b.dataset.leave}/leave`, "POST");
          showToast("–í—ã—à–ª–∏ ‚úÖ", true);
          await refreshTeamRuleUI();
          await loadOpenTeams();
        }catch(e){
          showToast(ruErrorMessage(e.message), false);
        }
      };
    });

  }catch(e){
    out.innerHTML = `<div class="empty bad">${esc(ruErrorMessage(e.message))}</div>`;
  }
}

async function loadMyTeams(){
  const out = document.getElementById("teamsOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;

  try{
    const res = await api("/my/teams");
    const teams = Array.isArray(res) ? res : (Array.isArray(res?.teams) ? res.teams : []);

    if (!teams.length){
      out.innerHTML = `<div class="empty">–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –Ω–∏ –≤ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ</div>`;
      return;
    }

    out.innerHTML = `<div class="stack">` + teams.map(t=>{
      const members = Array.isArray(t.members) ? t.members : [];
      const membersLine = t.is_open
        ? (members.length ? members.map(m=>esc(m.username)).join(", ") : "–ø–æ–∫–∞ –ø—É—Å—Ç–æ")
        : "—Å–∫—Ä—ã—Ç (–∑–∞–∫—Ä—ã—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞)";

      return `
        <div class="item glass inner">
          <div class="item-head">
            <div class="item-title">${esc(t.name)}</div>
            <div class="badges">
              <span class="badge">${t.is_open ? "open" : "closed"}</span>
              <span class="badge">–≤–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞</span>
            </div>
          </div>

          <div class="small muted" style="margin-top:8px;">
            –°–æ—Å—Ç–∞–≤: <b>${membersLine}</b>
          </div>

          <div class="item-actions" style="margin-top:10px;">
            <button class="btn secondary" data-leave="${t.id}">–í—ã–π—Ç–∏</button>
          </div>
        </div>
      `;
    }).join("") + `</div>`;

    out.querySelectorAll("button[data-leave]").forEach(b=>{
      b.onclick = async ()=>{
        try{
          await api(`/teams/${b.dataset.leave}/leave`, "POST");
          showToast("–í—ã –≤—ã—à–ª–∏ –∏–∑ –∫–æ–º–∞–Ω–¥—ã ‚úÖ", true);
          await refreshTeamRuleUI();
          await loadMyTeams();
        }catch(e){
          showToast(ruErrorMessage(e.message), false);
        }
      };
    });

  }catch(e){
    out.innerHTML = `<div class="empty bad">${esc(ruErrorMessage(e.message))}</div>`;
  }
}

/* ---------- history ---------- */
async function loadHistory(){
  const out = document.getElementById("historyOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>`;
  try{
    const res = await api("/history");
    const arr = Array.isArray(res) ? res : (Array.isArray(res?.history) ? res.history : []);
    if (!arr.length){
      out.innerHTML = `<div class="empty">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞—è</div>`;
      return;
    }
    out.innerHTML = `<div class="stack">` + arr.map(m=>`
      <div class="item glass inner">
        <div class="item-head">
          <div class="item-title">${esc(m.title)}</div>
          <div class="badges">
            <span class="badge">${esc(ruMatchStatus(m.status))}</span>
            <span class="badge">${esc(ruMode(m.mode))}</span>
          </div>
        </div>
      </div>
    `).join("") + `</div>`;
  }catch(e){
    out.innerHTML = `<div class="empty bad">${esc(ruErrorMessage(e.message))}</div>`;
  }
}
document.getElementById("reloadHistory").onclick = loadHistory;

/* ---------- rating ---------- */
async function loadRating(){
  const out = document.getElementById("ratingOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>`;
  try{
    const data = await api("/rating");
    const arr = Array.isArray(data) ? data : (Array.isArray(data?.users) ? data.users : []);
    if (!arr.length){
      out.innerHTML = `<div class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>`;
      return;
    }
    out.innerHTML = `
      <div class="tablewrap">
        <table class="table">
          <thead><tr><th>#</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–û—á–∫–∏</th></tr></thead>
          <tbody>
            ${arr.map((u,i)=>`
              <tr>
                <td>${i+1}</td>
                <td><b>${esc(u.username)}</b></td>
                <td><b>${Number(u.points ?? 0)}</b></td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>`;
  }catch(e){
    out.innerHTML = `<div class="empty bad">${esc(ruErrorMessage(e.message))}</div>`;
  }
}
document.getElementById("reloadRating").onclick = loadRating;

/* ---------- admin tabs ---------- */
function setAdminTab(key){
  document.querySelectorAll("#adminTabs .seg-btn").forEach(x=>{
    x.classList.toggle("active", x.dataset.admin===key);
  });
  ["matches","apps","users","teams","logs"].forEach(k=>{
    document.getElementById("admin-"+k).classList.toggle("hidden", k!==key);
  });
  if (key==="matches") loadAdminMatches();
  if (key==="apps") loadAdminApps();
  if (key==="users") loadAdminUsers();
  if (key==="teams") loadAdminTeams();
  if (key==="logs") loadAdminLogs();
}
document.querySelectorAll("#adminTabs .seg-btn").forEach(t=>{
  t.onclick = ()=> setAdminTab(t.dataset.admin);
});
document.getElementById("reloadApps").onclick = loadAdminApps;
document.getElementById("reloadUsers").onclick = loadAdminUsers;
document.getElementById("reloadLogs").onclick = loadAdminLogs;
document.getElementById("reloadTeamsAdmin").onclick = loadAdminTeams;

/* ---------- admin: logs/users/apps ---------- */
async function loadAdminLogs(){
  const out = document.getElementById("logsOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>`;
  try{
    const res = await api("/admin/logs");
    const logs = Array.isArray(res) ? res : (Array.isArray(res?.logs) ? res.logs : []);
    if (!logs.length){ out.innerHTML = `<div class="empty">–õ–æ–≥–∏ –ø—É—Å—Ç—ã–µ</div>`; return; }

    out.innerHTML = `
      <table class="table table-compact">
        <thead><tr><th>–í—Ä–µ–º—è</th><th>–ö—Ç–æ</th><th>–°–æ–±—ã—Ç–∏–µ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th></tr></thead>
        <tbody>
          ${logs.map(l=>`
            <tr>
              <td class="mono">${esc(l.created_at ?? "")}</td>
              <td><b>${esc(l.actor ?? "‚Äî")}</b></td>
              <td><span class="badge">${esc(showActionRu(l.action))}</span></td>
              <td class="muted td-wrap">${esc(l.details ?? "")}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>`;
  }catch(e){
    out.innerHTML = `<div class="empty bad">${esc(ruErrorMessage(e.message))}</div>`;
  }
}

async function loadAdminUsers(){
  const out = document.getElementById("usersOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>`;
  try{
    const res = await api("/admin/users");
    const users = Array.isArray(res) ? res : (Array.isArray(res?.users) ? res.users : []);
    if (!users.length){ out.innerHTML = `<div class="empty">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</div>`; return; }

    out.innerHTML = `
      <table class="table table-compact">
        <thead><tr><th>Username</th><th>Role</th><th>Points</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
        <tbody>
          ${users.map(u=>`
            <tr>
              <td><b>${esc(u.username)}</b></td>
              <td><span class="badge">${esc(u.role)}</span></td>
              <td><b>${Number(u.points ?? 0)}</b></td>
              <td>
                <div class="actions">
                  <button class="btn secondary btn-sm" data-pts="${u.id}">–û—á–∫–∏</button>
                  <button class="btn secondary btn-sm" data-del="${u.id}">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>`;

    out.querySelectorAll("button[data-pts]").forEach(b=>b.onclick=async()=>{
      const id = b.dataset.pts;
      const p = Number(prompt("–ù–æ–≤—ã–µ –æ—á–∫–∏:", "0"));
      if (!Number.isFinite(p)) return;
      try{
        await api(`/admin/users/${id}/points`,"POST",{points:p});
        showToast("–û—á–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã ‚úÖ", true);
        loadAdminUsers();
      }catch(e){
        showToast(ruErrorMessage(e.message), false);
      }
    });

    out.querySelectorAll("button[data-del]").forEach(b=>b.onclick=async()=>{
      const id = b.dataset.del;
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) return;
      try{
        await api(`/admin/users/${id}`,"DELETE");
        showToast("–£–¥–∞–ª–µ–Ω–æ ‚úÖ", true);
        loadAdminUsers();
      }catch(e){
        showToast(ruErrorMessage(e.message), false);
      }
    });
  }catch(e){
    out.innerHTML = `<div class="empty bad">${esc(ruErrorMessage(e.message))}</div>`;
  }
}

async function loadAdminApps(){
  const out = document.getElementById("appsOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</div>`;

  try{
    const res = await api("/admin/applications");
    const apps = Array.isArray(res) ? res : (Array.isArray(res?.applications) ? res.applications : []);
    if (!apps.length){ out.innerHTML = `<div class="empty">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</div>`; return; }

    out.innerHTML = `
      <table class="table table-compact">
        <thead>
          <tr>
            <th>–ú–∞—Ç—á</th>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–ö–æ–º–∞–Ω–¥–∞</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          ${apps.map(a=>{
            const st = String(a.status || "").toLowerCase();
            const decided = (st !== "pending");
            return `
              <tr>
                <td><b>${esc(a.match_title ?? a.match ?? "‚Äî")}</b></td>
                <td>${esc(a.username ?? a.user ?? "‚Äî")}</td>
                <td>${esc(a.team_name ?? a.team ?? "‚Äî")}</td>
                <td><span class="badge">${esc(ruAppStatus(a.status ?? ""))}</span></td>
                <td>
                  <div class="actions">
                    <button class="btn secondary btn-sm" data-ap="${a.id}" ${decided ? "disabled" : ""}>Approve</button>
                    <button class="btn secondary btn-sm" data-rj="${a.id}" ${decided ? "disabled" : ""}>Reject</button>
                  </div>
                </td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>`;

    out.querySelectorAll("button[data-ap]").forEach(b=>b.onclick=async()=>{
      try{
        await api(`/admin/applications/${b.dataset.ap}/approve`,"POST");
        showToast("–ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞ ‚úÖ", true);
        loadAdminApps();
      }catch(e){
        showToast(ruErrorMessage(e.message), false);
      }
    });

    out.querySelectorAll("button[data-rj]").forEach(b=>b.onclick=async()=>{
      try{
        await api(`/admin/applications/${b.dataset.rj}/reject`,"POST");
        showToast("–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ ‚úÖ", true);
        loadAdminApps();
      }catch(e){
        showToast(ruErrorMessage(e.message), false);
      }
    });

  }catch(e){
    out.innerHTML = `<div class="empty bad">${esc(ruErrorMessage(e.message))}</div>`;
  }
}

/* ---------- admin: teams ---------- */
async function loadAdminTeams(){
  const out = document.getElementById("teamsAdminOut");
  const teamSel = document.getElementById("adminTeamSel");
  const userSel = document.getElementById("adminUserSel");

  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;

  try{
    const [teamsRes, usersRes] = await Promise.all([
      api("/admin/teams"),
      api("/admin/users"),
    ]);

    const teams = Array.isArray(teamsRes) ? teamsRes : (Array.isArray(teamsRes?.teams) ? teamsRes.teams : []);
    const users = Array.isArray(usersRes) ? usersRes : (Array.isArray(usersRes?.users) ? usersRes.users : []);

    // —Å–µ–ª–µ–∫—Ç: —Ç–æ–ª—å–∫–æ –∑–∞–∫—Ä—ã—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã
    teamSel.innerHTML = `<option value="">‚Äî –≤—ã–±–µ—Ä–∏ –∫–æ–º–∞–Ω–¥—É ‚Äî</option>` + teams
      .filter(t => !t.is_open)
      .map(t => `<option value="${t.id}">${esc(t.name)} ‚Ä¢ ${Number(t.members_count ?? 0)}/${MAX_TEAM_MEMBERS}</option>`)
      .join("");

    // —Å–µ–ª–µ–∫—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–∫—Ä–æ–º–µ –∞–¥–º–∏–Ω–æ–≤)
    userSel.innerHTML = `<option value="">‚Äî –≤—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî</option>` + users
      .filter(u => String(u.role || "").toLowerCase() !== "admin")
      .map(u => `<option value="${u.id}">${esc(u.username)} ‚Ä¢ points=${Number(u.points ?? 0)}</option>`)
      .join("");

    if (!teams.length){
      out.innerHTML = `<div class="empty">–ö–æ–º–∞–Ω–¥ –Ω–µ—Ç</div>`;
      return;
    }

    out.innerHTML = `
      <table class="table table-compact">
        <thead>
          <tr>
            <th>–ö–æ–º–∞–Ω–¥–∞</th>
            <th style="width:120px;">–¢–∏–ø</th>
            <th style="width:160px;">–£—á–∞—Å—Ç–Ω–∏–∫–∏</th>
          </tr>
        </thead>
        <tbody>
          ${teams.map(t=>`
            <tr>
              <td><b>${esc(t.name)}</b></td>
              <td><span class="badge">${t.is_open ? "open" : "closed"}</span></td>
              <td><b>${Number(t.members_count ?? 0)}/${MAX_TEAM_MEMBERS}</b></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }catch(e){
    out.innerHTML = `<div class="empty bad">${esc(ruErrorMessage(e.message))}</div>`;
  }
}

document.getElementById("adminAddToTeamBtn").onclick = async ()=>{
  const teamId = Number(document.getElementById("adminTeamSel").value || "0");
  const userId = Number(document.getElementById("adminUserSel").value || "0");

  if (!teamId){ showToast("–í—ã–±–µ—Ä–∏ –∑–∞–∫—Ä—ã—Ç—É—é –∫–æ–º–∞–Ω–¥—É.", false); return; }
  if (!userId){ showToast("–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.", false); return; }

  try{
    await api(`/admin/teams/${teamId}/add-user`, "POST", { user_id: userId });
    showToast("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω ‚úÖ", true);
    await loadAdminTeams();
  }catch(e){
    showToast(ruErrorMessage(e.message), false);
  }
};

/* ---------- admin matches ---------- */
document.getElementById("mCreate").onclick = async()=>{
  let title = document.getElementById("mTitle").value;
  title = clampStr(title, LIMITS.MATCH_TITLE);
  document.getElementById("mTitle").value = title;

  const mode = document.getElementById("mMode").value;
  if (!title){ showToast("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞.", false); return; }

  try{
    await api("/admin/matches","POST",{title,mode});
    document.getElementById("mTitle").value = "";
    showToast("–ú–∞—Ç—á —Å–æ–∑–¥–∞–Ω ‚úÖ", true);
    await loadAdminMatches();
  }catch(e){
    showToast(ruErrorMessage(e.message), false);
  }
};
document.getElementById("mListAll").onclick = loadAdminMatches;

async function loadAdminMatches(){
  const status = document.getElementById("mFilter").value;
  const out = document.getElementById("matchesAdminOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
  try{
    const res = await api(`/admin/matches?status=${encodeURIComponent(status)}`);
    const matches = Array.isArray(res) ? res : (Array.isArray(res?.matches) ? res.matches : []);
    if (!matches.length){ out.innerHTML = `<div class="empty">–ú–∞—Ç—á–µ–π –Ω–µ—Ç</div>`; return; }

    out.innerHTML = `
      <table class="table table-compact">
        <thead>
          <tr>
            <th style="width:34%;">–ú–∞—Ç—á</th>
            <th style="width:90px;">–†–µ–∂–∏–º</th>
            <th style="width:140px;">–°—Ç–∞—Ç—É—Å</th>
            <th style="width:210px;">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</th>
            <th style="width:130px;">–û—á–∫–∏</th>
            <th style="width:320px;">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          ${matches.map(m=>{
            const isFinished = String(m.status).toLowerCase()==="finished";
            return `
              <tr data-mid="${m.id}">
                <td><b>${esc(m.title)}</b></td>
                <td><span class="badge">${esc(ruMode(m.mode))}</span></td>
                <td><span class="badge">${esc(ruMatchStatus(m.status))}</span></td>

                <td>
                  <select class="winnerSel ${isFinished ? "hidden" : "hidden"}" data-wu="${m.id}">
                    <option value="">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)</option>
                  </select>
                  <select class="winnerSel ${isFinished ? "hidden" : "hidden"}" data-wt="${m.id}">
                    <option value="">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å (–∫–æ–º–∞–Ω–¥–∞)</option>
                  </select>
                  <div class="small muted hintLine">${isFinished ? "–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω" : "–ù–∞–∂–º–∏ ¬´–£—á–∞—Å—Ç–Ω–∏–∫–∏¬ª"}</div>
                </td>

                <td>
                  <input class="bpInput" data-bp="${m.id}" value="0" inputmode="numeric" maxlength="7" style="width:100%;" ${isFinished ? "disabled" : ""}>
                </td>

                <td>
                  <div class="actions actions-wide">
                    ${isFinished ? `
                      <button class="btn secondary btn-sm" data-report="${m.id}">–û—Ç—á—ë—Ç</button>
                    ` : `
                      <button class="btn secondary btn-sm" data-part="${m.id}">–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
                      <button class="btn btn-sm" data-win="${m.id}">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</button>
                      <button class="btn secondary btn-sm" data-report="${m.id}">–û—Ç—á—ë—Ç</button>
                    `}
                  </div>
                </td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>`;

    out.querySelectorAll("button[data-part]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.part;
        const row = out.querySelector(`tr[data-mid="${id}"]`);
        const hint = row.querySelector(".hintLine");
        hint.classList.remove("bad");
        hint.textContent = "–ó–∞–≥—Ä—É–∂–∞—é —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...";

        const selU = row.querySelector(`select[data-wu="${id}"]`);
        const selT = row.querySelector(`select[data-wt="${id}"]`);

        try{
          const data = await api(`/admin/matches/${id}/participants`);
          hint.textContent = "";

          selU.innerHTML = `<option value="">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)</option>`;
          selT.innerHTML = `<option value="">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å (–∫–æ–º–∞–Ω–¥–∞)</option>`;

          if (data.match.mode === "solo"){
            selT.classList.add("hidden");
            selU.classList.remove("hidden");
            (data.users||[]).forEach(u=>{
              const opt = document.createElement("option");
              opt.value = String(u.id);
              opt.textContent = `${u.username} (points=${u.points})`;
              selU.appendChild(opt);
            });
            if (!(data.users||[]).length) hint.textContent = "–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.";
          }else{
            selU.classList.add("hidden");
            selT.classList.remove("hidden");
            (data.teams||[]).forEach(t=>{
              const opt = document.createElement("option");
              opt.value = String(t.id);
              opt.textContent = `${t.name} ‚Ä¢ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${(t.members||[]).length}`;
              selT.appendChild(opt);
            });
            if (!(data.teams||[]).length) hint.textContent = "–ù–µ—Ç –∫–æ–º–∞–Ω–¥-—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.";
          }
        }catch(e){
          hint.textContent = ruErrorMessage(e.message);
          hint.classList.add("bad");
        }
      };
    });

    out.querySelectorAll("button[data-win]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.win;
        const row = out.querySelector(`tr[data-mid="${id}"]`);
        const hint = row.querySelector(".hintLine");
        hint.classList.remove("bad");
        hint.textContent = "";

        const selU = row.querySelector(`select[data-wu="${id}"]`);
        const selT = row.querySelector(`select[data-wt="${id}"]`);
        const bp = Number((row.querySelector(`input[data-bp="${id}"]`).value||"0").trim());

        const winnerUserId = (!selU.classList.contains("hidden") && selU.value) ? Number(selU.value) : null;
        const winnerTeamId = (!selT.classList.contains("hidden") && selT.value) ? Number(selT.value) : null;

        if (!winnerUserId && !winnerTeamId){
          hint.textContent = "–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–£—á–∞—Å—Ç–Ω–∏–∫–∏¬ª –∏ –≤—ã–±–µ—Ä–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.";
          hint.classList.add("bad");
          return;
        }

        try{
          await api(`/admin/matches/${id}/winner`, "POST", {
            winner_user_id: winnerUserId,
            winner_team_id: winnerTeamId,
            bonus_points: Number.isFinite(bp) ? bp : 0
          });
          showToast("–ü–æ–±–µ–¥–∏—Ç–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚úÖ", true);
          await loadAdminMatches();
        }catch(e){
          hint.textContent = ruErrorMessage(e.message);
          hint.classList.add("bad");
        }
      };
    });

    out.querySelectorAll("button[data-report]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.report;
        try{
          const r = await api(`/admin/matches/${id}/report`);
          document.getElementById("reportText").textContent = r.report || "";
          document.getElementById("reportCard").classList.remove("hidden");
          document.getElementById("reportCard").scrollIntoView({behavior:"smooth", block:"start"});
        }catch(e){
          showToast(ruErrorMessage(e.message), false);
        }
      };
    });

  }catch(e){
    out.innerHTML = `<div class="empty bad">${esc(ruErrorMessage(e.message))}</div>`;
  }
}

document.getElementById("closeReport").onclick = ()=>{
  document.getElementById("reportCard").classList.add("hidden");
  document.getElementById("reportText").textContent = "";
};
document.getElementById("copyReport").onclick = async ()=>{
  try{
    await navigator.clipboard.writeText(document.getElementById("reportText").textContent);
    showToast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ", true);
  }catch{
    showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å", false);
  }
};

// –∫–æ–º–∞–Ω–¥—ã –∫–Ω–æ–ø–∫–∏
document.getElementById("listTeams").onclick = async () => {
  setView("teams");
  await refreshTeamRuleUI();
  await loadOpenTeams();
};
document.getElementById("listMyTeams").onclick = async () => {
  setView("teams");
  await refreshTeamRuleUI();
  await loadMyTeams();
};

/* ---------- init ---------- */
await loadMe();
await refreshTeamRuleUI();
setView("matches");
await loadMatches("open");
setAdminTab("matches");
</script>
</body>
</html>
