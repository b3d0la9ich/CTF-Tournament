<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Ä¢ CTF Tournament</title>
  <link rel="stylesheet" href="/static/assets/styles.css">
</head>

<body class="app landing">
<header class="appbar">
  <div class="landing-shell appbar-inner">
    <div class="brand">
      <div class="brand-mark">CTF</div>
      <div class="brand-text">
        <div class="brand-title">CTF Tournament</div>
        <div class="brand-sub">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</div>
      </div>
    </div>

    <div class="appbar-right">
      <div class="pill" id="who">user ‚Ä¢ points=0</div>
      <button class="btn secondary" id="ratingBtn">–†–µ–π—Ç–∏–Ω–≥</button>
      <button class="btn secondary" id="logoutBtn">–í—ã—Ö–æ–¥</button>
    </div>
  </div>
</header>

<main class="landing-shell app-layout">
  <!-- SIDEBAR -->
  <aside class="side glass">
    <div class="side-top">
      <div class="side-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
      <div class="small muted" id="roleHint">‚Äî</div>
    </div>

    <div class="side-nav">
      <button class="navbtn active" data-view="matches">
        <span class="navico">üéØ</span><span>–ú–∞—Ç—á–∏</span>
      </button>
      <button class="navbtn" data-view="teams">
        <span class="navico">üë•</span><span>–ö–æ–º–∞–Ω–¥—ã</span>
      </button>
      <button class="navbtn" data-view="history">
        <span class="navico">üïò</span><span>–ò—Å—Ç–æ—Ä–∏—è</span>
      </button>
      <button class="navbtn" data-view="rating">
        <span class="navico">üèÜ</span><span>–†–µ–π—Ç–∏–Ω–≥</span>
      </button>

      <div class="side-sep"></div>

      <button class="navbtn hidden" id="navAdmin" data-view="admin">
        <span class="navico">üõ†</span><span>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</span>
      </button>
    </div>

    <div class="side-foot">
      <div class="meta grid">
        <div class="meta-item">
          <div class="meta-label">–†–æ–ª—å</div>
          <div class="meta-value" id="roleLine">‚Äî</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">–û—á–∫–∏</div>
          <div class="meta-value" id="pointsLine">‚Äî</div>
        </div>
      </div>

      <div class="small muted" style="margin-top:10px;">
        –ü–æ—Ç–æ–∫: –∑–∞—è–≤–∫–∞ ‚Üí approve ‚Üí —É—á–∞—Å—Ç–Ω–∏–∫ ‚Üí –∞–¥–º–∏–Ω –≤—Ä—É—á–Ω—É—é –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª—è ‚Üí –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤ (team ‚Äî –≤—Å–µ–º —á–ª–µ–Ω–∞–º).
      </div>
    </div>
  </aside>

  <!-- CONTENT -->
  <section class="content">
    <div id="toast" class="toast hidden"></div>

    <!-- MATCHES -->
    <section id="view-matches" class="panel glass">
      <div class="panel-head">
        <div>
          <h2>–ú–∞—Ç—á–∏</h2>
          <div class="muted small">–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ç—á–∏ –∏ –ø–æ–¥–∞—á–∞ –∑–∞—è–≤–æ–∫</div>
        </div>
        <div class="tabs">
          <button class="tab active" data-status="open">open</button>
          <button class="tab" data-status="closed">closed</button>
          <button class="tab" data-status="finished">finished</button>
        </div>
      </div>

      <div id="matchesOut" class="panel-body">
        <div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </section>

    <!-- TEAMS -->
    <section id="view-teams" class="panel glass hidden">
      <div class="panel-head">
        <div>
          <h2>–ö–æ–º–∞–Ω–¥—ã</h2>
          <div class="muted small">–°–æ–∑–¥–∞–Ω–∏–µ, –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ, –≤—ã—Ö–æ–¥</div>
        </div>
        <div class="row">
          <button class="btn secondary" id="listTeams">–û—Ç–∫—Ä—ã—Ç—ã–µ</button>
          <button class="btn secondary" id="listMyTeams">–ú–æ–∏</button>
        </div>
      </div>

      <div class="panel-body">
        <div class="card glass inner">
          <div class="grid2">
            <label class="field">
              <span class="field-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã</span>
              <input id="teamName" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: byteBusters">
            </label>

            <label class="field">
              <span class="field-label">–¢–∏–ø</span>
              <select id="teamOpen">
                <option value="true">–û—Ç–∫—Ä—ã—Ç–∞—è</option>
                <option value="false">–ó–∞–∫—Ä—ã—Ç–∞—è</option>
              </select>
            </label>
          </div>

          <div class="row" style="margin-top:10px; align-items:center;">
            <button class="btn" id="createTeam">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
            <div class="small muted" id="teamRuleHint">–û—Ç–∫—Ä—ã—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã –º–æ–∂–Ω–æ —Å–≤–æ–±–æ–¥–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—Ç—å.</div>
          </div>
        </div>

        <div id="teamsOut" class="stack"></div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="view-history" class="panel glass hidden">
      <div class="panel-head">
        <div>
          <h2>–ò—Å—Ç–æ—Ä–∏—è —É—á–∞—Å—Ç–∏—è</h2>
          <div class="muted small">–ú–∞—Ç—á–∏, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Ç—ã —É—á–∞—Å—Ç–≤–æ–≤–∞–ª (–ø–æ—Å–ª–µ approve)</div>
        </div>
        <button class="btn secondary" id="reloadHistory">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div id="historyOut" class="panel-body">
        <div class="empty muted">–ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é.</div>
      </div>
    </section>

    <!-- RATING -->
    <section id="view-rating" class="panel glass hidden">
      <div class="panel-head">
        <div>
          <h2>–†–µ–π—Ç–∏–Ω–≥</h2>
          <div class="muted small">–¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –æ—á–∫–∞–º</div>
        </div>
        <button class="btn secondary" id="reloadRating">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div id="ratingOut" class="panel-body">
        <div class="empty muted">–ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥.</div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="view-admin" class="panel glass hidden">
      <div class="panel-head">
        <div>
          <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
          <div class="muted small">–ú–∞—Ç—á–∏, –∑–∞—è–≤–∫–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –ª–æ–≥–∏</div>
        </div>
        <div class="tabs">
          <button class="tab active" data-admin="matches">–ú–∞—Ç—á–∏</button>
          <button class="tab" data-admin="apps">–ó–∞—è–≤–∫–∏</button>
          <button class="tab" data-admin="users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
          <button class="tab" data-admin="logs">–õ–æ–≥–∏</button>
        </div>
      </div>

      <div class="panel-body admin-grid">
        <!-- admin matches -->
        <section id="admin-matches" class="card glass inner">
          <div class="card-head">
            <div class="card-title">–ú–∞—Ç—á–∏ CTF</div>
            <div class="muted small">–°–æ–∑–¥–∞–Ω–∏–µ / —Å–ø–∏—Å–æ–∫ / –ø–æ–±–µ–¥–∏—Ç–µ–ª—å</div>
          </div>

          <div class="grid2">
            <label class="field">
              <span class="field-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞</span>
              <input id="mTitle" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: Crypto Sprint">
            </label>
            <label class="field">
              <span class="field-label">–†–µ–∂–∏–º</span>
              <select id="mMode">
                <option value="solo">Solo</option>
                <option value="team">Team</option>
              </select>
            </label>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn" id="mCreate">–°–æ–∑–¥–∞—Ç—å –º–∞—Ç—á</button>
            <label class="field" style="max-width:220px;">
              <span class="field-label">–§–∏–ª—å—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞</span>
              <select id="mFilter">
                <option value="all">–í—Å–µ</option>
                <option value="open">open</option>
                <option value="closed">closed</option>
                <option value="finished">finished</option>
              </select>
            </label>
            <button class="btn secondary" id="mListAll">–ü–æ–∫–∞–∑–∞—Ç—å</button>
          </div>

          <div id="matchesAdminOut" class="stack" style="margin-top:12px;"></div>
        </section>

        <!-- admin apps -->
        <section id="admin-apps" class="card glass inner hidden">
          <div class="card-head">
            <div class="card-title">–ó–∞—è–≤–∫–∏</div>
            <div class="muted small">Approve / Reject</div>
          </div>
          <div id="appsOut" class="stack"></div>
        </section>

        <!-- admin users -->
        <section id="admin-users" class="card glass inner hidden">
          <div class="card-head">
            <div class="card-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
            <div class="muted small">–û—á–∫–∏ –∏ —É–¥–∞–ª–µ–Ω–∏–µ</div>
          </div>
          <div id="usersOut"></div>
        </section>

        <!-- admin logs -->
        <section id="admin-logs" class="card glass inner hidden">
          <div class="card-head">
            <div class="card-title">–õ–æ–≥–∏</div>
            <div class="muted small">–î–µ–π—Å—Ç–≤–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ</div>
          </div>
          <div id="logsOut"></div>
        </section>

        <!-- report modal -->
        <section id="reportCard" class="card glass inner hidden">
          <div class="card-head">
            <div class="card-title">–û—Ç—á—ë—Ç</div>
            <div class="row">
              <button class="btn secondary" id="copyReport">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="btn secondary" id="closeReport">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
          </div>
          <pre id="reportText" class="pre"></pre>
        </section>
      </div>
    </section>

    <div id="err" class="small errline"></div>
  </section>
</main>

<div class="noise"></div>

<script type="module">
import { api } from "/static/assets/api.js";

const errEl = document.getElementById("err");
const who = document.getElementById("who");
const toast = document.getElementById("toast");

const roleLine = document.getElementById("roleLine");
const pointsLine = document.getElementById("pointsLine");
const roleHint = document.getElementById("roleHint");

const navAdmin = document.getElementById("navAdmin");

const createTeamBtn = document.getElementById("createTeam");
const teamRuleHint = document.getElementById("teamRuleHint");

const views = ["matches","teams","history","rating","admin"].reduce((acc,k)=>{
  acc[k]=document.getElementById("view-"+k);
  return acc;
},{});

function err(m){ errEl.textContent = m || ""; }
function showToast(text, ok=true){
  toast.textContent = text;
  toast.classList.remove("hidden");
  toast.classList.toggle("bad", !ok);
  setTimeout(()=> toast.classList.add("hidden"), 2200);
}

function setView(name){
  Object.keys(views).forEach(k=>{
    if (k===name) views[k].classList.remove("hidden");
    else views[k].classList.add("hidden");
  });
  document.querySelectorAll(".navbtn").forEach(b=>{
    b.classList.toggle("active", b.dataset.view===name);
  });
}

document.getElementById("logoutBtn").onclick = async () => {
  await api("/auth/logout","POST");
  location.href="/";
};

document.getElementById("ratingBtn").onclick = () => {
  setView("rating");
  loadRating();
};

document.querySelectorAll(".navbtn").forEach(b=>{
  b.onclick = () => {
    const v = b.dataset.view;
    setView(v);
    if (v==="matches") loadMatches(activeStatus());
    if (v==="teams") { /* –Ω–∏—á–µ–≥–æ –∞–≤—Ç–æ */ }
    if (v==="history") loadHistory();
    if (v==="rating") loadRating();
    if (v==="admin") { /* –Ω–∏—á–µ–≥–æ –∞–≤—Ç–æ */ }
  };
});

function activeStatus(){
  const a = document.querySelector("#view-matches .tab.active");
  return a ? a.dataset.status : "open";
}

document.querySelectorAll("#view-matches .tab").forEach(t=>{
  t.onclick = () => {
    document.querySelectorAll("#view-matches .tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    loadMatches(t.dataset.status);
  };
});

/* ---------- load me ---------- */
async function loadMe(){
  err("");
  try{
    const me = await api("/me");
    who.textContent = `${me.username} (${me.role}) ‚Ä¢ points=${me.points}`;
    roleLine.textContent = me.role;
    pointsLine.textContent = String(me.points);
    roleHint.textContent = me.role === "admin" ? "–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏" : "–ü–æ–¥–∞—á–∞ –∑–∞—è–≤–æ–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–∞–º–∏";

    if (me.role === "admin") navAdmin.classList.remove("hidden");
    else navAdmin.classList.add("hidden");
  }catch(e){
    location.href="/login";
  }
}

/* ---------- team rule helpers ---------- */
async function getMyTeams(){
  const resTeams = await api("/my/teams");
  return Array.isArray(resTeams) ? resTeams : (Array.isArray(resTeams?.teams) ? resTeams.teams : []);
}

async function refreshTeamRuleUI(){
  try{
    const myTeams = await getMyTeams();
    const hasTeam = (myTeams || []).length > 0;

    if (hasTeam){
      createTeamBtn.disabled = true;
      createTeamBtn.classList.add("secondary");
      teamRuleHint.textContent = "–í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–æ–º–∞–Ω–¥–µ. –ß—Ç–æ–±—ã –≤—Å—Ç—É–ø–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å –¥—Ä—É–≥—É—é ‚Äî —Å–Ω–∞—á–∞–ª–∞ –≤—ã–π–¥–∏—Ç–µ –∏–∑ —Ç–µ–∫—É—â–µ–π.";
    } else {
      createTeamBtn.disabled = false;
      createTeamBtn.classList.remove("secondary");
      teamRuleHint.textContent = "–û—Ç–∫—Ä—ã—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã –º–æ–∂–Ω–æ —Å–≤–æ–±–æ–¥–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—Ç—å.";
    }
  }catch{
    // ignore
  }
}

/* ---------- user: matches ---------- */
async function loadMatches(status){
  const out = document.getElementById("matchesOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç—á–µ–π...</div>`;

  let matches = [];
  let myApps = {};
  let myTeams = [];

  try{
    const res = await api(`/matches?status=${encodeURIComponent(status)}`);
    matches = Array.isArray(res) ? res : (Array.isArray(res?.matches) ? res.matches : []);

    const resApps = await api("/my/applications");
    myApps = (resApps && typeof resApps === "object") ? resApps : {};

    myTeams = await getMyTeams();
  }catch(e){
    out.innerHTML = `<div class="empty bad">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</div>`;
    return;
  }

  if (!matches.length){
    out.innerHTML = `<div class="empty">–ú–∞—Ç—á–µ–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º <b>${status}</b> –Ω–µ—Ç</div>`;
    return;
  }

  // ‚úÖ —É–±—Ä–∞–ª–∏ (#id) –∏–∑ –≤—ã–±–æ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã
  const teamOptions = (myTeams||[]).map(t=>`<option value="${t.id}">${t.name}</option>`).join("");

  out.innerHTML = `<div class="stack">` + matches.map(m=>{
    const appSt = myApps[m.id] || "none";
    const applied = appSt !== "none";
    const badge = appSt==="none" ? "–∑–∞—è–≤–∫–∞: ‚Äî" : `–∑–∞—è–≤–∫–∞: ${appSt}`;

    const teamPick = (m.mode==="team") ? `
      <label class="field inline">
        <span class="field-label">–ö–æ–º–∞–Ω–¥–∞</span>
        <select data-team="${m.id}">
          <option value="">–í—ã–±–µ—Ä–∏ –∫–æ–º–∞–Ω–¥—É</option>
          ${teamOptions}
        </select>
      </label>` : "";

    const btnText = applied ? "–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞" : "–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É";

    return `
      <div class="item glass inner">
        <div class="item-head">
          <div class="item-title">${m.title}</div>
          <div class="badges">
            <span class="badge">${m.status}</span>
            <span class="badge">${m.mode}</span>
            <span class="badge">${badge}</span>
          </div>
        </div>

        <div class="item-actions">
          ${teamPick}
          <button class="btn ${applied ? "secondary" : ""}" data-apply="${m.id}" ${applied ? "disabled" : ""}>${btnText}</button>
          <div class="small muted"></div>
        </div>
      </div>
    `;
  }).join("") + `</div>`;

  out.querySelectorAll("button[data-apply]").forEach(btn=>{
    btn.onclick = async () => {
      const matchId = Number(btn.dataset.apply);
      const card = btn.closest(".item");
      const msg = card.querySelector(".small");
      msg.textContent = "";
      msg.classList.remove("bad");

      const m = matches.find(x=>x.id===matchId);
      if (!m) return;

      let body = {};
      if (m.mode==="team"){
        const sel = card.querySelector(`select[data-team="${matchId}"]`);
        const teamId = sel ? sel.value : "";
        if (!teamId){
          msg.textContent = "–í—ã–±–µ—Ä–∏ –∫–æ–º–∞–Ω–¥—É –¥–ª—è team-–º–∞—Ç—á–∞.";
          msg.classList.add("bad");
          return;
        }
        body.team_id = Number(teamId);
      }

      try{
        await api(`/matches/${matchId}/apply`, "POST", body);
        btn.textContent = "–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ (pending)";
        btn.disabled = true;
        btn.classList.add("secondary");
        showToast("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚úÖ", true);
      }catch(e){
        msg.textContent = "–û—à–∏–±–∫–∞: " + e.message;
        msg.classList.add("bad");
      }
    };
  });
}

/* ---------- user: teams ---------- */
document.getElementById("createTeam").onclick = async () => {
  try{
    const myTeams = await getMyTeams();
    if ((myTeams||[]).length > 0){
      showToast("–°–Ω–∞—á–∞–ª–∞ –≤—ã–π–¥–∏—Ç–µ –∏–∑ —Ç–µ–∫—É—â–µ–π –∫–æ–º–∞–Ω–¥—ã.", false);
      await refreshTeamRuleUI();
      return;
    }
  }catch{}

  const name = document.getElementById("teamName").value.trim();
  const is_open = document.getElementById("teamOpen").value === "true";
  if (!name){ showToast("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã", false); return; }

  try{
    await api("/teams","POST",{name,is_open});
    showToast("–ö–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–Ω–∞ ‚úÖ", true);
    document.getElementById("teamName").value = "";
    await refreshTeamRuleUI();
    await loadMyTeams();
  }catch(e){
    showToast("–û—à–∏–±–∫–∞: " + e.message, false);
  }
};

async function loadOpenTeams(){
  const out = document.getElementById("teamsOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;

  try{
    const [openRes, myRes] = await Promise.all([
      api("/teams/open"),
      api("/my/teams")
    ]);

    const teams = Array.isArray(openRes) ? openRes : (Array.isArray(openRes?.teams) ? openRes.teams : []);
    const myTeams = Array.isArray(myRes) ? myRes : (Array.isArray(myRes?.teams) ? myRes.teams : []);

    const mySet = new Set((myTeams || []).map(t => t.id));
    const alreadyInAnyTeam = mySet.size > 0;

    if (!teams.length){
      out.innerHTML = `<div class="empty">–û—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ–º–∞–Ω–¥ –Ω–µ—Ç</div>`;
      return;
    }

    out.innerHTML = `<div class="stack">` + teams.map(t=>{
      const inThisTeam = mySet.has(t.id);

      const members = Array.isArray(t.members) ? t.members : [];
      const membersLine = t.is_open
        ? (members.length ? members.map(m=>m.username).join(", ") : "–ø–æ–∫–∞ –ø—É—Å—Ç–æ")
        : "—Å–∫—Ä—ã—Ç";

      const canJoin = (!inThisTeam && !alreadyInAnyTeam);

      return `
        <div class="item glass inner">
          <div class="item-head">
            <div class="item-title">${t.name}</div>
            <div class="badges">
              <span class="badge">${t.is_open ? "open" : "closed"}</span>
              ${inThisTeam ? `<span class="badge">–≤—ã —É—á–∞—Å—Ç–Ω–∏–∫</span>` : ``}
            </div>
          </div>

          <div class="small muted" style="margin-top:8px;">
            –°–æ—Å—Ç–∞–≤: <b>${membersLine}</b>
          </div>

          <div class="item-actions" style="margin-top:10px;">
            ${canJoin ? `<button class="btn secondary" data-join="${t.id}">–í—Å—Ç—É–ø–∏—Ç—å</button>` : ``}
            ${inThisTeam ? `<button class="btn secondary" data-leave="${t.id}">–í—ã–π—Ç–∏</button>` : ``}
            ${(!inThisTeam && alreadyInAnyTeam) ? `<div class="small muted">–ü–æ–∫–∞ –≤—ã –≤ –∫–æ–º–∞–Ω–¥–µ ‚Äî –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –¥—Ä—É–≥–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.</div>` : ``}
          </div>
        </div>
      `;
    }).join("") + `</div>`;

    out.querySelectorAll("button[data-join]").forEach(b=>{
      b.onclick = async ()=>{
        try{
          await api(`/teams/${b.dataset.join}/join`, "POST");
          showToast("–í—Å—Ç—É–ø–∏–ª–∏ ‚úÖ", true);
          await refreshTeamRuleUI();
          await loadOpenTeams();
        }catch(e){
          showToast("–û—à–∏–±–∫–∞: " + e.message, false);
        }
      };
    });

    out.querySelectorAll("button[data-leave]").forEach(b=>{
      b.onclick = async ()=>{
        try{
          await api(`/teams/${b.dataset.leave}/leave`, "POST");
          showToast("–í—ã—à–ª–∏ ‚úÖ", true);
          await refreshTeamRuleUI();
          await loadOpenTeams();
        }catch(e){
          showToast("–û—à–∏–±–∫–∞: " + e.message, false);
        }
      };
    });

  }catch(e){
    out.innerHTML = `<div class="empty bad">–û—à–∏–±–∫–∞: ${e.message}</div>`;
  }
}

async function loadMyTeams(){
  const out = document.getElementById("teamsOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;

  try{
    const res = await api("/my/teams");
    const teams = Array.isArray(res) ? res : (Array.isArray(res?.teams) ? res.teams : []);

    if (!teams.length){
      out.innerHTML = `<div class="empty">–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –Ω–∏ –≤ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ</div>`;
      return;
    }

    out.innerHTML = `<div class="stack">` + teams.map(t=>{
      const members = Array.isArray(t.members) ? t.members : [];

      const membersLine = t.is_open
        ? (members.length ? members.map(m=>m.username).join(", ") : "–ø–æ–∫–∞ –ø—É—Å—Ç–æ")
        : "—Å–∫—Ä—ã—Ç (–∑–∞–∫—Ä—ã—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞)";

      return `
        <div class="item glass inner">
          <div class="item-head">
            <div class="item-title">${t.name}</div>
            <div class="badges">
              <span class="badge">${t.is_open ? "open" : "closed"}</span>
              <span class="badge">–≤–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞</span>
            </div>
          </div>

          <div class="small muted" style="margin-top:8px;">
            –°–æ—Å—Ç–∞–≤: <b>${membersLine}</b>
          </div>

          <div class="item-actions" style="margin-top:10px;">
            <button class="btn secondary" data-leave="${t.id}">–í—ã–π—Ç–∏</button>
          </div>
        </div>
      `;
    }).join("") + `</div>`;

    out.querySelectorAll("button[data-leave]").forEach(b=>{
      b.onclick = async ()=>{
        try{
          await api(`/teams/${b.dataset.leave}/leave`, "POST");
          showToast("–í—ã –≤—ã—à–ª–∏ –∏–∑ –∫–æ–º–∞–Ω–¥—ã ‚úÖ", true);
          await refreshTeamRuleUI();
          await loadMyTeams();
        }catch(e){
          showToast("–û—à–∏–±–∫–∞: " + e.message, false);
        }
      };
    });

  }catch(e){
    out.innerHTML = `<div class="empty bad">–û—à–∏–±–∫–∞: ${e.message}</div>`;
  }
}

/* ---------- user: history ---------- */
async function loadHistory(){
  const out = document.getElementById("historyOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>`;
  try{
    const res = await api("/history");
    const arr = Array.isArray(res) ? res : (Array.isArray(res?.history) ? res.history : []);
    if (!arr.length){
      out.innerHTML = `<div class="empty">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞—è</div>`;
      return;
    }
    out.innerHTML = `<div class="stack">` + arr.map(m=>`
      <div class="item glass inner">
        <div class="item-head">
          <div class="item-title">${m.title}</div>
          <div class="badges">
            <span class="badge">${m.status}</span>
            <span class="badge">${m.mode}</span>
          </div>
        </div>
      </div>
    `).join("") + `</div>`;
  }catch(e){
    out.innerHTML = `<div class="empty bad">–û—à–∏–±–∫–∞: ${e.message}</div>`;
  }
}
document.getElementById("reloadHistory").onclick = loadHistory;

/* ---------- rating ---------- */
async function loadRating(){
  const out = document.getElementById("ratingOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>`;
  try{
    const data = await api("/rating");
    const arr = Array.isArray(data) ? data : (Array.isArray(data?.users) ? data.users : []);
    if (!arr.length){
      out.innerHTML = `<div class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>`;
      return;
    }
    out.innerHTML = `
      <div class="tablewrap">
        <table class="table">
          <thead><tr><th>#</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–†–æ–ª—å</th><th>–û—á–∫–∏</th></tr></thead>
          <tbody>
            ${arr.map((u,i)=>`
              <tr>
                <td>${i+1}</td>
                <td><b>${u.username}</b></td>
                <td><span class="badge">${u.role}</span></td>
                <td><b>${u.points}</b></td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>`;
  }catch(e){
    out.innerHTML = `<div class="empty bad">–û—à–∏–±–∫–∞: ${e.message}</div>`;
  }
}
document.getElementById("reloadRating").onclick = loadRating;

/* ---------- admin tabs ---------- */
document.querySelectorAll("#view-admin .tab").forEach(t=>{
  t.onclick = () => {
    document.querySelectorAll("#view-admin .tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const key = t.dataset.admin;

    ["matches","apps","users","logs"].forEach(k=>{
      document.getElementById("admin-"+k).classList.toggle("hidden", k!==key);
    });

    if (key==="apps") loadAdminApps();
    if (key==="users") loadAdminUsers();
    if (key==="logs") loadAdminLogs();
  };
});

/* ---------- admin: logs/users/apps ---------- */
async function loadAdminLogs(){
  const out = document.getElementById("logsOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>`;
  try{
    const res = await api("/admin/logs");
    const logs = Array.isArray(res) ? res : (Array.isArray(res?.logs) ? res.logs : []);
    if (!logs.length){ out.innerHTML = `<div class="empty">–õ–æ–≥–∏ –ø—É—Å—Ç—ã–µ</div>`; return; }

    // ‚úÖ —É–±—Ä–∞–ª–∏ ID –∫–æ–ª–æ–Ω–∫—É
    out.innerHTML = `
      <div class="tablewrap">
        <table class="table">
          <thead><tr><th>Time</th><th>Actor</th><th>Action</th><th>Details</th></tr></thead>
          <tbody>
            ${logs.map(l=>`
              <tr>
                <td>${l.created_at ?? ""}</td>
                <td><b>${l.actor ?? ""}</b></td>
                <td><span class="badge">${l.action ?? ""}</span></td>
                <td class="muted">${l.details ?? ""}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>`;
  }catch(e){
    out.innerHTML = `<div class="empty bad">–û—à–∏–±–∫–∞: ${e.message}</div>`;
  }
}

async function loadAdminUsers(){
  const out = document.getElementById("usersOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>`;
  try{
    const res = await api("/admin/users");
    const users = Array.isArray(res) ? res : (Array.isArray(res?.users) ? res.users : []);
    if (!users.length){ out.innerHTML = `<div class="empty">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</div>`; return; }

    // ‚úÖ —É–±—Ä–∞–ª–∏ ID –∫–æ–ª–æ–Ω–∫—É (–Ω–æ id —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ data-–∞—Ç—Ä–∏–±—É—Ç–∞—Ö)
    out.innerHTML = `
      <div class="tablewrap">
        <table class="table">
          <thead><tr><th>Username</th><th>Role</th><th>Points</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
          <tbody>
            ${users.map(u=>`
              <tr>
                <td><b>${u.username}</b></td>
                <td><span class="badge">${u.role}</span></td>
                <td><b>${u.points}</b></td>
                <td>
                  <div class="row">
                    <button class="btn secondary" data-pts="${u.id}">–û—á–∫–∏</button>
                    <button class="btn secondary" data-del="${u.id}">–£–¥–∞–ª–∏—Ç—å</button>
                  </div>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>`;

    out.querySelectorAll("button[data-pts]").forEach(b=>b.onclick=async()=>{
      const id = b.dataset.pts;
      const p = Number(prompt("–ù–æ–≤—ã–µ –æ—á–∫–∏:", "0"));
      if (!Number.isFinite(p)) return;
      try{ await api(`/admin/users/${id}/points`,"POST",{points:p}); showToast("–û—á–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã ‚úÖ", true); loadAdminUsers(); }
      catch(e){ showToast("–û—à–∏–±–∫–∞: "+e.message, false); }
    });

    out.querySelectorAll("button[data-del]").forEach(b=>b.onclick=async()=>{
      const id = b.dataset.del;
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) return;
      try{ await api(`/admin/users/${id}`,"DELETE"); showToast("–£–¥–∞–ª–µ–Ω–æ ‚úÖ", true); loadAdminUsers(); }
      catch(e){ showToast("–û—à–∏–±–∫–∞: "+e.message, false); }
    });
  }catch(e){
    out.innerHTML = `<div class="empty bad">–û—à–∏–±–∫–∞: ${e.message}</div>`;
  }
}

async function loadAdminApps(){
  const out = document.getElementById("appsOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</div>`;

  try{
    const res = await api("/admin/applications");
    const apps = Array.isArray(res) ? res : (Array.isArray(res?.applications) ? res.applications : []);
    if (!apps.length){ out.innerHTML = `<div class="empty">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</div>`; return; }

    // ‚úÖ —Ä–µ—à–µ–Ω–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ: –µ—Å–ª–∏ –Ω–µ pending ‚Äî –∫–Ω–æ–ø–∫–∏ disabled
    out.innerHTML = `<div class="tablewrap">
      <table class="table">
        <thead>
          <tr>
            <th>–ú–∞—Ç—á</th>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–ö–æ–º–∞–Ω–¥–∞</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          ${apps.map(a=>{
            const team = (a.team_name && a.team_name.trim()) ? a.team_name : "‚Äî";
            const st = String(a.status || "").toLowerCase();
            const decided = (st !== "pending");

            return `
              <tr>
                <td><b>${a.match_title ?? "‚Äî"}</b></td>
                <td>${a.username ?? "‚Äî"}</td>
                <td>${team}</td>
                <td><span class="badge">${a.status ?? ""}</span></td>
                <td>
                  <div class="row">
                    <button class="btn secondary" data-ap="${a.id}" ${decided ? "disabled" : ""}>Approve</button>
                    <button class="btn secondary" data-rj="${a.id}" ${decided ? "disabled" : ""}>Reject</button>
                  </div>
                  ${decided ? `<div class="small muted">–†–µ—à–µ–Ω–∏–µ —É–∂–µ –ø—Ä–∏–Ω—è—Ç–æ</div>` : ``}
                </td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    </div>`;

    out.querySelectorAll("button[data-ap]").forEach(b=>b.onclick=async()=>{
      try{ await api(`/admin/applications/${b.dataset.ap}/approve`,"POST"); showToast("Approved ‚úÖ", true); loadAdminApps(); }
      catch(e){ showToast("–û—à–∏–±–∫–∞: "+e.message, false); }
    });

    out.querySelectorAll("button[data-rj]").forEach(b=>b.onclick=async()=>{
      try{ await api(`/admin/applications/${b.dataset.rj}/reject`,"POST"); showToast("Rejected ‚úÖ", true); loadAdminApps(); }
      catch(e){ showToast("–û—à–∏–±–∫–∞: "+e.message, false); }
    });

  }catch(e){
    out.innerHTML = `<div class="empty bad">–û—à–∏–±–∫–∞: ${e.message}</div>`;
  }
}

/* admin matches list + winner/report */
document.getElementById("mCreate").onclick = async()=>{
  const title = document.getElementById("mTitle").value.trim();
  const mode = document.getElementById("mMode").value;
  if (!title){ showToast("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞", false); return; }
  try{
    await api("/admin/matches","POST",{title,mode});
    document.getElementById("mTitle").value = "";
    showToast("–ú–∞—Ç—á —Å–æ–∑–¥–∞–Ω ‚úÖ", true);
    await loadAdminMatches();
  }catch(e){
    showToast("–û—à–∏–±–∫–∞: "+e.message, false);
  }
};

document.getElementById("mListAll").onclick = loadAdminMatches;

async function loadAdminMatches(){
  const status = document.getElementById("mFilter").value;
  const out = document.getElementById("matchesAdminOut");
  out.innerHTML = `<div class="skeleton">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
  try{
    const res = await api(`/admin/matches?status=${encodeURIComponent(status)}`);
    const matches = Array.isArray(res) ? res : (Array.isArray(res?.matches) ? res.matches : []);
    if (!matches.length){ out.innerHTML = `<div class="empty">–ú–∞—Ç—á–µ–π –Ω–µ—Ç</div>`; return; }

    out.innerHTML = `<div class="stack">` + matches.map(m=>`
      <div class="item glass inner">
        <div class="item-head">
          <div class="item-title">${m.title}</div>
          <div class="badges">
            <span class="badge">${m.status}</span>
            <span class="badge">${m.mode}</span>
          </div>
        </div>

        <div class="item-actions">
          <button class="btn secondary" data-part="${m.id}">–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>

          <select data-winner-user="${m.id}" class="hidden">
            <option value="">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å (user)</option>
          </select>

          <select data-winner-team="${m.id}" class="hidden">
            <option value="">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å (team)</option>
          </select>

          <label class="field inline" style="max-width:160px;">
            <span class="field-label">–û—á–∫–∏</span>
            <input data-bp="${m.id}" value="0" inputmode="numeric">
          </label>

          <button class="btn" data-win="${m.id}">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</button>
          <button class="btn secondary" data-close="${m.id}">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button class="btn secondary" data-report="${m.id}">–û—Ç—á—ë—Ç</button>

          <div class="small muted"></div>
        </div>
      </div>
    `).join("") + `</div>`;

    out.querySelectorAll("button[data-part]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.part;
        const card = btn.closest(".item");
        const msg = card.querySelector(".small");
        msg.textContent = "–ó–∞–≥—Ä—É–∂–∞—é —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...";
        msg.classList.remove("bad");

        const selU = card.querySelector(`select[data-winner-user="${id}"]`);
        const selT = card.querySelector(`select[data-winner-team="${id}"]`);

        try{
          const data = await api(`/admin/matches/${id}/participants`);
          msg.textContent = "";

          selU.innerHTML = `<option value="">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å (user)</option>`;
          selT.innerHTML = `<option value="">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å (team)</option>`;

          if (data.match.mode === "solo"){
            selT.classList.add("hidden");
            selU.classList.remove("hidden");
            (data.users||[]).forEach(u=>{
              const opt = document.createElement("option");
              opt.value = String(u.id);
              opt.textContent = `${u.username} (points=${u.points})`;
              selU.appendChild(opt);
            });
            if (!(data.users||[]).length) msg.textContent = "–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.";
          }else{
            selU.classList.add("hidden");
            selT.classList.remove("hidden");
            (data.teams||[]).forEach(t=>{
              const members = (t.members||[]).map(x=>x.username).join(", ");
              const opt = document.createElement("option");
              opt.value = String(t.id);
              opt.textContent = `${t.name} ‚Äî —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${(t.members||[]).length} [${members}]`;
              selT.appendChild(opt);
            });
            if (!(data.teams||[]).length) msg.textContent = "–ù–µ—Ç –∫–æ–º–∞–Ω–¥-—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.";
          }
        }catch(e){
          msg.textContent = "–û—à–∏–±–∫–∞: "+e.message;
          msg.classList.add("bad");
        }
      };
    });

    out.querySelectorAll("button[data-win]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.win;
        const card = btn.closest(".item");
        const msg = card.querySelector(".small");
        msg.textContent = "";
        msg.classList.remove("bad");

        const selU = card.querySelector(`select[data-winner-user="${id}"]`);
        const selT = card.querySelector(`select[data-winner-team="${id}"]`);
        const bp = Number((card.querySelector(`input[data-bp="${id}"]`).value||"0").trim());

        const winnerUserId = (!selU.classList.contains("hidden") && selU.value) ? Number(selU.value) : null;
        const winnerTeamId = (!selT.classList.contains("hidden") && selT.value) ? Number(selT.value) : null;

        try{
          await api(`/admin/matches/${id}/winner`, "POST", {
            winner_user_id: winnerUserId,
            winner_team_id: winnerTeamId,
            bonus_points: Number.isFinite(bp) ? bp : 0
          });
          showToast("–ü–æ–±–µ–¥–∏—Ç–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚úÖ", true);
          btn.disabled = true;
        }catch(e){
          msg.textContent = "–û—à–∏–±–∫–∞: " + e.message + " (–Ω–∞–∂–º–∏ ¬´–£—á–∞—Å—Ç–Ω–∏–∫–∏¬ª –∏ –≤—ã–±–µ—Ä–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è)";
          msg.classList.add("bad");
        }
      };
    });

    out.querySelectorAll("button[data-close]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.close;
        try{
          await api(`/admin/matches/${id}/close`, "POST", {});
          showToast("–ú–∞—Ç—á –∑–∞–∫—Ä—ã—Ç ‚úÖ", true);
          loadAdminMatches();
        }catch(e){
          showToast("–û—à–∏–±–∫–∞: "+e.message, false);
        }
      };
    });

    out.querySelectorAll("button[data-report]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.report;
        try{
          const r = await api(`/admin/matches/${id}/report`);
          document.getElementById("reportText").textContent = r.report || "";
          document.getElementById("reportCard").classList.remove("hidden");
          document.getElementById("reportCard").scrollIntoView({behavior:"smooth", block:"start"});
        }catch(e){
          showToast("–û—à–∏–±–∫–∞: "+e.message, false);
        }
      };
    });

  }catch(e){
    out.innerHTML = `<div class="empty bad">–û—à–∏–±–∫–∞: ${e.message}</div>`;
  }
}

document.getElementById("closeReport").onclick = ()=>{
  document.getElementById("reportCard").classList.add("hidden");
  document.getElementById("reportText").textContent = "";
};
document.getElementById("copyReport").onclick = async ()=>{
  try{
    await navigator.clipboard.writeText(document.getElementById("reportText").textContent);
    showToast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ", true);
  }catch{
    showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å", false);
  }
};

// ‚úÖ –§–ò–ö–°: —ç—Ç–∏ –∫–Ω–æ–ø–∫–∏ –≤—Å–µ–≥–¥–∞ —Ä–µ–∞–ª—å–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç teams
document.getElementById("listTeams").onclick = async () => {
  setView("teams");
  await refreshTeamRuleUI();
  await loadOpenTeams();
};

document.getElementById("listMyTeams").onclick = async () => {
  setView("teams");
  await refreshTeamRuleUI();
  await loadMyTeams();
};

/* ---------- init ---------- */
await loadMe();
await refreshTeamRuleUI();
setView("matches");
await loadMatches("open");
</script>
</body>
</html>
